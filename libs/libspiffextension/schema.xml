<?xml version="1.0"?>
<schema version="0.3">
  <!-- Defines extensions (=plugins) -->
  <table name="extension">
    <opt platform="mysql">ENGINE=INNODB</opt>
    <field name="id" type="I">
      <NOTNULL/>
      <KEY/>
      <AUTOINCREMENT/>
    </field>
    <field name="handle" type="C" size="20">
      <NOTNULL/>
    </field>
    <field name="name" type="C" size="40">
      <NOTNULL/>
    </field>
    <field name="version" type="C" size="20">
      <NOTNULL/>
    </field>
    <field name="description" type="C" size="255">
      <NOTNULL/>
    </field>

    <index name="extension_handle">
      <col>handle</col>
      <UNIQUE/>
    </index>
    <index name="extension_name_version">
      <col>name</col>
      <col>version</col>
      <UNIQUE/>
    </index>
  </table>
  <sql>
    <query>
    ALTER TABLE extension TYPE = innodb
    </query>
  </sql>

  <!-- Contains a list of all dependencies between extensions. -->
  <table name="extension_dependency">
    <opt platform="mysql">TYPE=INNODB</opt>
    <field name="id" type="I">
      <NOTNULL/>
      <KEY/>
      <AUTOINCREMENT/>
    </field>
    <field name="extension_id" type="I">
      <NOTNULL/>
    </field>
    <field name="dependency_handle" type="C" size="20">
      <NOTNULL/>
    </field>
    <field name="dependency_operator" type="I">
      <NOTNULL/>
    </field>
    <field name="dependency_version" type="C" size="20">
      <NOTNULL/>
    </field>

    <index name="extension_dependency_extension_id">
      <col>extension_id</col>
    </index>
    <index name="extension_dependency_dependency_handle">
      <col>dependency_handle</col>
    </index>
    <index name="extension_dependency_dependency_operator">
      <col>dependency_operator</col>
    </index>
    <index name="extension_dependency_dependency_version">
      <col>dependency_version</col>
    </index>
  </table>
  <sql>
    <query>
    ALTER TABLE resource TYPE = innodb
    </query>
    <query>
    ALTER TABLE extension_dependency
    ADD FOREIGN KEY(extension_dependency_extension_id)
    REFERENCES extension(id)
    ON DELETE CASCADE
    </query>
  </sql>

  <!-- Contains a tree that reflects the dependencies between
       extensions. -->
  <table name="extension_tree">
    <opt platform="mysql">TYPE=INNODB</opt>
    <field name="id" type="I">
      <NOTNULL/>
      <KEY/>
      <AUTOINCREMENT/>
    </field>
    <field name="lft" type="I">
      <NOTNULL/>
    </field>
    <field name="rgt" type="I">
      <NOTNULL/>
    </field>
    <field name="extension_id" type="I">
      <NOTNULL/>
    </field>

    <index name="extension_tree_lft">
      <col>lft</col>
    </index>
    <index name="extension_tree_rgt">
      <col>rgt</col>
    </index>
    <index name="extension_tree_extension_id">
      <col>extension_id</col>
    </index>
  </table>
  <sql>
    <query>
    ALTER TABLE resource TYPE = innodb
    </query>
    <query>
    ALTER TABLE extension_tree
    ADD FOREIGN KEY(extension_tree_extension_id)
    REFERENCES extension(id)
    ON DELETE CASCADE
    </query>
  </sql>
</schema>
