<?xml version="1.0"?>
<schema version="0.3">

  <!-- Defines types of actions, e.g. "User Permissions",
       "Content Handling", etc. -->
  <table name="action_section">
    <opt platform="mysql">ENGINE=INNODB</opt>
    <field name="id" type="I">
      <NOTNULL/>
      <KEY/>
      <AUTOINCREMENT/>
    </field>
    <field name="handle" type="C" size="230">
      <NOTNULL/>
    </field>
    <field name="name" type="C" size="230">
      <NOTNULL/>
    </field>

    <index name="action_section_handle">
      <col>handle</col>
      <UNIQUE/>
    </index>
    <index name="action_section_name">
      <col>name</col>
      <UNIQUE/>
    </index>
  </table>
  <sql>
    <query>
    ALTER TABLE action_section TYPE = innodb
    </query>
  </sql>

  <!-- Defines types of resources, e.g. "Users",
       "Websites", etc. -->
  <table name="resource_section">
    <opt platform="mysql">TYPE=INNODB</opt>
    <field name="id" type="I">
      <NOTNULL/>
      <KEY/>
      <AUTOINCREMENT/>
    </field>
    <field name="handle" type="C" size="230">
      <NOTNULL/>
    </field>
    <field name="name" type="C" size="230">
      <NOTNULL/>
    </field>

    <index name="resource_section_handle">
      <col>handle</col>
      <UNIQUE/>
    </index>
    <index name="resource_section_name">
      <col>name</col>
      <UNIQUE/>
    </index>
  </table>
  <sql>
    <query>
    ALTER TABLE resource_section TYPE = innodb
    </query>
  </sql>

  <!-- Actions are like 'Read', 'Write', 'Execute', etc. -->
  <table name="action">
    <opt platform="mysql">TYPE=INNODB</opt>
    <field name="id" type="I">
      <NOTNULL/>
      <KEY/>
      <AUTOINCREMENT/>
    </field>
    <field name="section_handle" type="C" size="230">
      <NOTNULL/>
    </field>
    <field name="handle" type="C" size="230">
      <NOTNULL/>
    </field>
    <field name="name" type="C" size="230">
      <NOTNULL/>
    </field>

    <index name="action_section_handle">
      <col>section_handle</col>
    </index>
    <index name="action_handle">
      <col>handle</col>
    </index>
    <index name="action_name">
      <col>name</col>
    </index>
  </table>
  <sql>
    <query>
    ALTER TABLE action TYPE = innodb
    </query>
    <query>
    ALTER TABLE action
    ADD FOREIGN KEY(section_handle)
    REFERENCES action_section(handle)
    ON DELETE CASCADE
    </query>
  </sql>

  <!-- Resources are objects that can be accessed, and who can also
       access other objects. -->
  <table name="resource">
    <opt platform="mysql">TYPE=INNODB</opt>
    <field name="id" type="I">
      <NOTNULL/>
      <KEY/>
      <AUTOINCREMENT/>
    </field>
    <field name="section_handle" type="C" size="230">
      <NOTNULL/>
    </field>
    <field name="handle" type="C" size="230">
      <NOTNULL/>
    </field>
    <field name="name" type="C" size="230">
      <NOTNULL/>
    </field>
    <field name="is_actor" type="I">
      <DEFAULT value="0"/>
      <NOTNULL/>
    </field>
    <field name="is_group" type="I">
      <DEFAULT value="0"/>
      <NOTNULL/>
    </field>

    <index name="resource_section_handle">
      <col>section_handle</col>
    </index>
    <index name="resource_handle">
      <col>handle</col>
    </index>
    <index name="resource_name">
      <col>name</col>
    </index>
    <index name="resource_is_actor">
      <col>is_actor</col>
    </index>
    <index name="resource_is_group">
      <col>is_group</col>
    </index>
  </table>
  <sql>
    <query>
    ALTER TABLE resource TYPE = innodb
    </query>
    <query>
    ALTER TABLE resource
    ADD FOREIGN KEY(section_handle)
    REFERENCES resource_section(handle)
    ON DELETE CASCADE
    </query>
  </sql>

  <!-- This table adds optional attributes to each resource. Supported types
       are VARCHAR(200) and integer. -->
  <table name="resource_attribute">
    <opt platform="mysql">TYPE=INNODB</opt>
    <field name="id" type="I">
      <NOTNULL/>
      <KEY/>
      <AUTOINCREMENT/>
    </field>
    <field name="resource_id" type="I">
      <DEFAULT value="0"/>
      <NOTNULL/>
    </field>
    <field name="name" type="C" size="50">
      <NOTNULL/>
    </field>
    <field name="type" type="I">
      <DEFAULT value="0"/>
    </field>
    <field name="attr_string" type="C" size="200"/>
    <field name="attr_int" type="I"/>

    <index name="resource_attribute_resource_id">
      <col>resource_id</col>
    </index>
    <index name="resource_attribute_name">
      <col>name</col>
    </index>
  </table>
  <sql>
    <query>
    ALTER TABLE resource_attribute TYPE = innodb
    </query>
    <query>
    ALTER TABLE resource_attribute
    ADD FOREIGN KEY(id)
    REFERENCES resource(id)
    ON DELETE CASCADE
    </query>
  </sql>

  <!-- The resource path organizes objects into a tree.
       Every object can be placed under an arbitrary number of parent
       objects. -->
  <table name="resource_path">
    <opt platform="mysql">TYPE=INNODB</opt>
    <field name="id" type="I">
      <NOTNULL/>
      <KEY/>
      <AUTOINCREMENT/>
    </field>
    <field name="path" type="C" size="255">
      <NOTNULL/>
    </field>
    <field name="depth" type="I">
      <DEFAULT value="0"/>
    </field>
    <field name="resource_id" type="I">
      <DEFAULT value="0"/>
      <NOTNULL/>
    </field>
    <field name="n_children" type="I">
      <DEFAULT value="0"/>
    </field>
    <field name="refcount" type="I">
      <DEFAULT value="1"/>
    </field>
    
    <index name="resource_path_path">
      <col>path</col>
      <UNIQUE/>
    </index>
    <index name="resource_path_depth">
      <col>depth</col>
    </index>
    <index name="resource_path_resource_id">
      <col>resource_id</col>
    </index>
  </table>
  <sql>
    <query>
    ALTER TABLE resource_path TYPE = innodb
    </query>
    <query>
    ALTER TABLE resource_path
    ADD FOREIGN KEY(resource_id)
    REFERENCES resource(id)
    ON DELETE CASCADE
    </query>
  </sql>

  <!-- Contains a list of all ancestors of every item in the tree. -->
  <table name="path_ancestor_map">
    <opt platform="mysql">TYPE=INNODB</opt>
    <field name="resource_path" type="C" size="255">
      <NOTNULL/>
    </field>
    <field name="ancestor_path" type="C" size="255">
      <NOTNULL/>
    </field>

    <index name="path_ancestor_map_resource_path">
      <col>resource_path</col>
    </index>
    <index name="path_ancestor_map_ancestor_path">
      <col>ancestor_path</col>
    </index>
  </table>
  <sql>
    <query>
    ALTER TABLE path_ancestor_map TYPE = innodb
    </query>
    <query>
    ALTER TABLE path_ancestor_map
    ADD FOREIGN KEY(resource_path)
    REFERENCES resource_path(path)
    ON DELETE CASCADE
    </query>
    <query>
    ALTER TABLE path_ancestor_map
    ADD FOREIGN KEY(ancestor_path)
    REFERENCES resource_path(path)
    ON DELETE CASCADE
    </query>
  </sql>

  <!-- Defines the permission of each object. -->
  <table name="acl">
    <opt platform="mysql">TYPE=INNODB</opt>
    <field name="id" type="I">
      <NOTNULL/>
      <KEY/>
      <AUTOINCREMENT/>
    </field>
    <field name="actor_id" type="I">
      <NOTNULL/>
    </field>
    <field name="action_id" type="I">
      <NOTNULL/>
    </field>
    <field name="resource_id" type="I">
      <NOTNULL/>
    </field>
    <field name="permit" type="I">
      <DEFAULT value="0"/>
      <NOTNULL/>
    </field>
    
    <index name="acl_actor_id">
      <col>actor_id</col>
    </index>
    <index name="acl_action_id">
      <col>action_id</col>
    </index>
    <index name="acl_resource_id">
      <col>resource_id</col>
    </index>
    <index name="acl_permit">
      <col>permit</col>
    </index>
  </table>
  <sql>
    <query>
    ALTER TABLE acl TYPE = innodb
    </query>
    <query>
    ALTER TABLE acl
    ADD FOREIGN KEY(actor_id)
    REFERENCES resource_path(resource_id)
    ON DELETE CASCADE
    </query>
    <query>
    ALTER TABLE acl
    ADD FOREIGN KEY(action_id)
    REFERENCES action(id)
    ON DELETE CASCADE
    </query>
    <query>
    ALTER TABLE acl
    ADD FOREIGN KEY(resource_id)
    REFERENCES resource(id)
    ON DELETE CASCADE
    </query>
  </sql>
</schema>
